<!DOCTYPE html>
<html>
<head>
    <title>Test WebSocket Chat</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; }
        #messageInput { width: 70%; padding: 5px; }
        button { padding: 5px 10px; }
        .message { margin: 5px 0; }
        .status { color: blue; font-style: italic; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Test WebSocket Chat Direct</h1>
    <div id="status" class="status">Disconnected</div>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>

    <script>
        let socket = null;
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('status');
        const messageInput = document.getElementById('messageInput');

        function addMessage(content, className = '') {
            const div = document.createElement('div');
            div.className = `message ${className}`;
            div.textContent = content;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(status) {
            statusDiv.textContent = status;
            console.log('Status:', status);
        }

        function connect() {
            if (socket) {
                socket.close();
            }

            updateStatus('Connecting...');
            
            // Probar conexión directa al chat service
            socket = new WebSocket('ws://localhost:8003/ws');
            
            socket.onopen = function(event) {
                updateStatus('Connected');
                addMessage('✅ Connected to WebSocket', 'status');
                
                // Unirse al chat global
                const joinMessage = {
                    type: 'join_global',
                    data: {
                        user_id: 'test_user_' + Date.now(),
                        username: 'TestUser'
                    }
                };
                socket.send(JSON.stringify(joinMessage));
                console.log('Sent join message:', joinMessage);
            };

            socket.onmessage = function(event) {
                console.log('Received message:', event.data);
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'message') {
                        addMessage(`${message.data.username}: ${message.data.content}`);
                    } else if (message.type === 'user_joined') {
                        addMessage(`${message.data.username} joined the chat`, 'status');
                    } else {
                        addMessage(`[${message.type}] ${JSON.stringify(message.data)}`, 'status');
                    }
                } catch (e) {
                    addMessage(`Raw: ${event.data}`);
                }
            };

            socket.onclose = function(event) {
                updateStatus('Disconnected');
                addMessage('❌ Disconnected from WebSocket', 'error');
                console.log('WebSocket closed:', event);
            };

            socket.onerror = function(error) {
                updateStatus('Error');
                addMessage('❌ WebSocket error: ' + error, 'error');
                console.error('WebSocket error:', error);
            };
        }

        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }

        function sendMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addMessage('❌ Not connected', 'error');
                return;
            }

            const content = messageInput.value.trim();
            if (!content) return;

            const message = {
                type: 'send_message',
                data: {
                    content: content,
                    user_id: 'test_user_' + Date.now(),
                    username: 'TestUser'
                }
            };

            socket.send(JSON.stringify(message));
            console.log('Sent message:', message);
            messageInput.value = '';
        }

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
