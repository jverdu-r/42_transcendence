/**
 * Unified Online Game Page - Uses UnifiedGameRenderer
 */
import { navigateTo } from '../router';
import { getCurrentUser } from '../auth';
import { UnifiedGameRenderer, GameCallbacks } from '../components/UnifiedGameRenderer';
import { PlayerDisplay, PlayerInfo } from '../components/playerDisplay';

export function renderUnifiedGameOnline(): void {
    const pageContent = document.getElementById('page-content');
    
    if (!pageContent) {
        console.error('No se encontrÃ³ el contenedor de contenido para la pÃ¡gina online.');
        return;
    }

    // Interfaz principal del modo online mejorada
    pageContent.innerHTML = `
        <div class="w-full max-w-6xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">ğŸŒ Juego Online - Multijugador</h1>
                <p class="text-lg text-gray-300">Juega contra otros jugadores en tiempo real</p>
            </div>

            <!-- MenÃº principal online -->
            <div id="online-menu" class="space-y-6">
                <!-- Botones de acciÃ³n principales -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-lg p-6 hover:from-green-700 hover:to-green-900 transition-all cursor-pointer transform hover:scale-105" id="create-game-card">
                        <div class="text-center">
                            <div class="text-6xl mb-4">ğŸ®</div>
                            <h2 class="text-2xl font-bold text-white mb-2">Crear Nueva Partida</h2>
                            <p class="text-green-100 mb-4">Inicia una nueva partida y espera a que otros jugadores se unan</p>
                            <button class="bg-white text-green-800 font-bold py-2 px-6 rounded-full hover:bg-gray-100 transition-colors">
                                âœ¨ Crear Partida
                            </button>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg p-6 hover:from-blue-700 hover:to-blue-900 transition-all cursor-pointer transform hover:scale-105" id="refresh-games-card">
                        <div class="text-center">
                            <div class="text-6xl mb-4">ğŸ“‹</div>
                            <h2 class="text-2xl font-bold text-white mb-2">Partidas Disponibles</h2>
                            <p class="text-blue-100 mb-4">Ve la lista de partidas activas y Ãºnete a una</p>
                            <button class="bg-white text-blue-800 font-bold py-2 px-6 rounded-full hover:bg-gray-100 transition-colors">
                                ğŸ”„ Actualizar Lista
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de partidas disponibles -->
                <div id="games-list-section" class="bg-gray-800 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">ğŸ¯ Partidas Disponibles</h3>
                        <div id="loading-indicator" class="hidden">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
                        </div>
                    </div>
                    <div id="games-list">
                        <div class="text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">ğŸ”</div>
                            <p>Haz clic en "Actualizar Lista" para ver las partidas disponibles</p>
                        </div>
                    </div>
                </div>

                <!-- EstadÃ­sticas del jugador -->
                <div class="bg-gradient-to-r from-purple-800 to-pink-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸ“Š Tu InformaciÃ³n de Jugador</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-200" id="player-name">-</div>
                            <div class="text-sm text-purple-400">Nombre</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-pink-200" id="games-played">0</div>
                            <div class="text-sm text-pink-400">Partidas Jugadas</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-200" id="wins">0</div>
                            <div class="text-sm text-purple-400">Victorias</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-pink-200" id="win-rate">0%</div>
                            <div class="text-sm text-pink-400">% Victorias</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ãrea de juego (oculta inicialmente) -->
            <div id="game-area" class="hidden">
                <div class="bg-black rounded-lg p-4 flex justify-center mb-6">
                    <canvas id="game-canvas" width="800" height="600" class="border-2 border-white rounded"></canvas>
                </div>

                <!-- InformaciÃ³n del juego online -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-bold text-green-400 mb-2">ğŸŒ Estado de ConexiÃ³n</h3>
                        <div id="connection-status" class="text-sm text-gray-300">Desconectado</div>
                        <div id="game-id-display" class="text-xs text-gray-500 mt-2">ID: -</div>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-4 text-center">
                        <h3 class="text-lg font-bold text-purple-400 mb-4">âš½ Marcador</h3>
                        <div class="flex justify-between items-center">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-400" id="score-left">0</div>
                                <div class="text-sm text-gray-400" id="player1-name">Jugador 1</div>
                            </div>
                            <div class="text-2xl font-bold text-white">-</div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-blue-400" id="score-right">0</div>
                                <div class="text-sm text-gray-400" id="player2-name">Jugador 2</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-bold text-blue-400 mb-2">ğŸ® Estado del Juego</h3>
                        <div id="status-message" class="text-sm text-gray-300">Preparando...</div>
                        <div id="rally-counter" class="text-xs text-gray-500 mt-2">Rebotes: 0</div>
                    </div>
                </div>

                <!-- Botones de control de juego -->
                <div class="text-center mt-6">
                    <button id="leave-game" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded transition-colors mr-4">
                        ğŸšª Abandonar Partida
                    </button>
                    <button id="back-to-online-menu" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded transition-colors">
                        ğŸ  MenÃº Online
                    </button>
                </div>
            </div>

            <!-- BotÃ³n de regreso al menÃº principal -->
            <div class="text-center mt-8">
                <button id="back-to-main-menu" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded transition-colors">
                    â† Volver al MenÃº Principal
                </button>
            </div>
        </div>
    `;

    // Inicializar la interfaz online
    setupOnlineInterface();
}

function setupOnlineInterface(): void {
    const currentUser = getCurrentUser();
    const playerName = currentUser?.username || 'Jugador';
    
    // Mostrar informaciÃ³n del jugador
    const playerNameEl = document.getElementById('player-name');
    if (playerNameEl) playerNameEl.textContent = playerName;

    // Event listeners para las tarjetas principales
    document.getElementById('create-game-card')?.addEventListener('click', createNewGame);
    document.getElementById('refresh-games-card')?.addEventListener('click', loadAvailableGames);
    
    // Event listeners para navegaciÃ³n
    document.getElementById('back-to-main-menu')?.addEventListener('click', () => {
        navigateTo('/play');
    });

    document.getElementById('back-to-online-menu')?.addEventListener('click', () => {
        showOnlineMenu();
    });

    document.getElementById('leave-game')?.addEventListener('click', () => {
        // AquÃ­ irÃ­a la lÃ³gica para abandonar el juego
        showOnlineMenu();
    });

    // Cargar estadÃ­sticas del jugador
    loadPlayerStats();
    
    // Cargar lista inicial de partidas
    loadAvailableGames();
}

async function createNewGame(): Promise<void> {
    const currentUser = getCurrentUser();
    const playerName = currentUser?.username || 'Jugador';
    
    try {
        showLoading(true);
        
        const response = await fetch('/api/games', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nombre: `Partida de ${playerName}`,
                gameMode: 'pvp',
                maxPlayers: 2,
                playerName: playerName
            })
        });

        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }

        const gameData = await response.json();
        
        if (gameData.success && gameData.game) {
            console.log('âœ… Partida creada exitosamente:', gameData.game);
            
            // Mostrar mensaje de Ã©xito
            showStatusMessage(`ğŸ® Partida creada: ${gameData.game.id}`, 'success');
            
            // Iniciar el juego
            await startOnlineGame(gameData.game.id, 1); // Como creador, somos el jugador 1
        } else {
            throw new Error(gameData.error || 'Error desconocido al crear la partida');
        }
        
    } catch (error: any) {
        console.error('âŒ Error al crear partida:', error);
        showStatusMessage(`âŒ Error: ${(error as Error).message}`, 'error');
    } finally {
        showLoading(false);
    }
}

async function loadAvailableGames(): Promise<void> {
    try {
        showLoading(true);
        
        const response = await fetch('/api/games');
        
        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }

        const gamesData = await response.json();
        displayGamesList(gamesData.games || []);
        
    } catch (error: any) {
        console.error('âŒ Error al cargar partidas:', error);
        showStatusMessage(`âŒ Error al cargar partidas: ${(error as Error).message}`, 'error');
        displayGamesList([]);
    } finally {
        showLoading(false);
    }
}

function displayGamesList(games: any[]): void {
    const gamesListEl = document.getElementById('games-list');
    if (!gamesListEl) return;

    if (games.length === 0) {
        gamesListEl.innerHTML = `
            <div class="text-center py-8 text-gray-400">
                <div class="text-4xl mb-4">ğŸ˜´</div>
                <p class="text-lg mb-2">No hay partidas disponibles</p>
                <p class="text-sm">Â¡SÃ© el primero en crear una!</p>
            </div>
        `;
        return;
    }

    const gamesHTML = games.map(game => `
        <div class="bg-gray-700 rounded-lg p-4 mb-3 hover:bg-gray-600 transition-colors">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h4 class="font-bold text-white mb-1">ğŸ¯ ${game.nombre || `Partida ${game.id}`}</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-gray-300">
                        <div>ğŸ†” ID: <span class="text-yellow-400">${game.id}</span></div>
                        <div>ğŸ‘¥ Jugadores: <span class="text-blue-400">${game.jugadoresConectados}/${game.capacidadMaxima}</span></div>
                        <div>ğŸ“Š Estado: <span class="text-green-400">${game.estado}</span></div>
                        <div>ğŸ® Tipo: <span class="text-purple-400">${game.tipoJuego}</span></div>
                    </div>
                    ${game.jugadores && game.jugadores.length > 0 ? `
                        <div class="mt-2 text-xs text-gray-400">
                            Jugadores: ${game.jugadores.map((p: any) => p.nombre).join(', ')}
                        </div>
                    ` : ''}
                </div>
                <div class="ml-4">
                    ${game.jugadoresConectados < game.capacidadMaxima ? `
                        <button onclick="joinGame('${game.id}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-colors">
                            ğŸš€ Unirse
                        </button>
                    ` : `
                        <button disabled 
                                class="bg-gray-500 text-gray-300 font-bold py-2 px-4 rounded cursor-not-allowed">
                            ğŸ”’ Llena
                        </button>
                    `}
                </div>
            </div>
        </div>
    `).join('');

    gamesListEl.innerHTML = gamesHTML;
}

// FunciÃ³n global para unirse a partidas (llamada desde el HTML)
(window as any).joinGame = async function(gameId: string): Promise<void> {
    const currentUser = getCurrentUser();
    const playerName = currentUser?.username || 'Jugador';
    
    try {
        showLoading(true);
        
        const response = await fetch(`/api/${gameId}/join`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                playerName: playerName
            })
        });

        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
            console.log('âœ… Unido a partida exitosamente:', result);
            showStatusMessage(`ğŸ® Te has unido a la partida ${gameId}`, 'success');
            
            // Determinar nÃºmero de jugador (probablemente 2 si nos estamos uniendo)
            const playerNumber = result.playerNumber || 2;
            await startOnlineGame(gameId, playerNumber);
        } else {
            throw new Error(result.error || 'Error desconocido al unirse a la partida');
        }
        
    } catch (error: any) {
        console.error('âŒ Error al unirse a partida:', error);
        showStatusMessage(`âŒ Error: ${(error as Error).message}`, 'error');
    } finally {
        showLoading(false);
    }
};

async function startOnlineGame(gameId: string, playerNumber: number): Promise<void> {
    const currentUser = getCurrentUser();
    const playerName = currentUser?.username || 'Jugador';
    
    try {
        // Ocultar menÃº online y mostrar Ã¡rea de juego
        document.getElementById('online-menu')?.classList.add('hidden');
        document.getElementById('game-area')?.classList.remove('hidden');
        
        // Actualizar informaciÃ³n del juego
        const gameIdDisplay = document.getElementById('game-id-display');
        if (gameIdDisplay) gameIdDisplay.textContent = `ID: ${gameId}`;
        
        const connectionStatus = document.getElementById('connection-status');
        if (connectionStatus) connectionStatus.textContent = 'Conectando...';

        // Crear renderer de juego
        const canvas = document.getElementById('game-canvas') as HTMLCanvasElement;
        if (!canvas) {
            throw new Error('Canvas no encontrado');
        }

        const gameRenderer = new UnifiedGameRenderer(canvas, 'online');
        
        // Set up player info (initial)
        const player1Info: PlayerInfo = {
            numero: 1,
            displayName: playerNumber === 1 ? playerName : 'Esperando...',
            username: playerNumber === 1 ? (currentUser?.username || 'player1') : 'waiting',
            controls: 'W/S'
        };

        const player2Info: PlayerInfo = {
            numero: 2,
            displayName: playerNumber === 2 ? playerName : 'Esperando...',
            username: playerNumber === 2 ? (currentUser?.username || 'player2') : 'waiting',
            controls: 'W/S'
        };

        gameRenderer.setPlayerInfo(player1Info, player2Info);

        // Configurar callbacks
        gameRenderer.setCallbacks({
            onScoreUpdate: (score) => {
                const leftScore = document.getElementById('score-left');
                const rightScore = document.getElementById('score-right');
                if (leftScore) leftScore.textContent = score.left.toString();
                if (rightScore) rightScore.textContent = score.right.toString();
            },
            onGameEnd: (winner, finalScore) => {
                const statusMsg = document.getElementById('status-message');
                if (statusMsg) {
                    statusMsg.innerHTML = `
                        <div class="text-green-400 font-bold">ğŸ‰ Â¡${winner} ha ganado!</div>
                        <div class="text-sm text-gray-400 mt-1">Resultado final: ${finalScore.left} - ${finalScore.right}</div>
                    `;
                }
            },
            onStatusUpdate: (status) => {
                const statusMsg = document.getElementById('status-message');
                if (statusMsg) statusMsg.textContent = status;
            },
            onGameStateUpdate: (gameState) => {
                const rallyCounter = document.getElementById('rally-counter');
                if (rallyCounter) {
                    rallyCounter.textContent = `Rebotes: ${gameState.rallieCount || 0}`;
                }
            }
        });

        // Conectar al juego online
        const connected = await gameRenderer.connectToOnlineGame(gameId, playerNumber);
        
        if (connected) {
            const connectionStatus = document.getElementById('connection-status');
            if (connectionStatus) {
                connectionStatus.innerHTML = `
                    <div class="text-green-400">ğŸŸ¢ Conectado</div>
                    <div class="text-xs text-gray-400">Jugador ${playerNumber}</div>
                `;
            }
        } else {
            throw new Error('No se pudo conectar al juego');
        }
        
    } catch (error: any) {
        console.error('âŒ Error al iniciar juego online:', error);
        showStatusMessage(`âŒ Error: ${(error as Error).message}`, 'error');
        showOnlineMenu();
    }
}

function showOnlineMenu(): void {
    document.getElementById('online-menu')?.classList.remove('hidden');
    document.getElementById('game-area')?.classList.add('hidden');
    
    // Recargar lista de partidas
    loadAvailableGames();
}

function showLoading(show: boolean): void {
    const loadingEl = document.getElementById('loading-indicator');
    if (loadingEl) {
        if (show) {
            loadingEl.classList.remove('hidden');
        } else {
            loadingEl.classList.add('hidden');
        }
    }
}

function showStatusMessage(message: string, type: 'success' | 'error' | 'info' = 'info'): void {
    // Crear elemento de notificaciÃ³n temporal
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remover despuÃ©s de 3 segundos
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

function loadPlayerStats(): void {
    // Cargar estadÃ­sticas del localStorage o API
    try {
        const stats = JSON.parse(localStorage.getItem('pongGameStats') || '[]');
        const gamesPlayed = stats.length;
        const wins = stats.filter((game: any) => game.winner === getCurrentUser()?.username).length;
        const winRate = gamesPlayed > 0 ? Math.round((wins / gamesPlayed) * 100) : 0;
        
        const gamesPlayedEl = document.getElementById('games-played');
        const winsEl = document.getElementById('wins');
        const winRateEl = document.getElementById('win-rate');
        
        if (gamesPlayedEl) gamesPlayedEl.textContent = gamesPlayed.toString();
        if (winsEl) winsEl.textContent = wins.toString();
        if (winRateEl) winRateEl.textContent = `${winRate}%`;
        
    } catch (error: any) {
        console.error('Error loading player stats:', error);
    }
}
